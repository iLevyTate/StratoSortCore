# Mac release workflow — run on tag push or manually.
# Builds on macos-latest (Apple Silicon). For Intel DMG, add a matrix or separate job.
name: Release (macOS)

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Mac app and DMG
        run: npm run dist:mac

      # Notarization requires Apple Developer ID. Uncomment when ready:
      # - name: Notarize app
      #   env:
      #     APPLE_ID: ${{ secrets.APPLE_ID }}
      #     APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #   run: |
      #     xcrun notarytool submit release/build/*.dmg --wait
      #     xcrun stapler staple release/build/*.dmg

      - name: Generate SHA256 checksums
        run: |
          cd release/build
          for f in StratoSortCore-*.dmg StratoSortCore-*.zip; do
            [ -f "$f" ] && shasum -a 256 "$f" >> checksums.sha256 || true
          done

      - name: Build release notes
        run: |
          echo "## Release Notes" > release/build/release-notes.md
          echo "" >> release/build/release-notes.md
          echo "- **Vision runtime is included** — no separate download needed." >> release/build/release-notes.md
          echo "- Use **Download Base Models** after install to enable AI features." >> release/build/release-notes.md
          echo "- See the [Install Guide](https://github.com/iLevyTate/StratoSortCore/blob/main/docs/INSTALL_GUIDE.md) for Windows & Mac — one download, no CLI." >> release/build/release-notes.md
          echo "" >> release/build/release-notes.md
          echo "See CHANGELOG.md for details." >> release/build/release-notes.md

      - name: Publish release artifacts
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: false
          body_path: release/build/release-notes.md
          fail_on_unmatched_files: false
          files: |
            release/build/StratoSortCore-*.dmg
            release/build/StratoSortCore-*.zip
            release/build/checksums.sha256
