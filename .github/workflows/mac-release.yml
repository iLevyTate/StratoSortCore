# Mac release workflow â€” run on tag push.
# electron-builder is configured to emit both arm64 and x64 mac artifacts.
name: Release (macOS)

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: 'npm'
      - name: Install Dependencies
        run: npm ci
      - name: Check formatting
        run: npm run format:check
      - name: Lint
        run: npm run lint
      - name: Run tests with coverage
        run: npm run test:coverage
      - name: Verify IPC handlers
        run: npm run verify:ipc-handlers
      - name: Build
        run: npm run build

  build-macos:
    needs: quality-gates
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: macos-13
            dist_script: dist:mac:x64
          - arch: arm64
            runner: macos-14
            dist_script: dist:mac:arm64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies (with optional deps)
        run: npm ci --include=optional

      - name: Rebuild native modules for Electron runtime
        run: npx --no electron-builder install-app-deps

      - name: Build Mac app and DMG (${{ matrix.arch }})
        run: npm run ${{ matrix.dist_script }}

      # Notarization requires Apple Developer ID. Uncomment when ready:
      # - name: Notarize app
      #   env:
      #     APPLE_ID: ${{ secrets.APPLE_ID }}
      #     APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #   run: |
      #     xcrun notarytool submit release/build/*.dmg --wait
      #     xcrun stapler staple release/build/*.dmg

      - name: Stage artifacts
        run: |
          set -euo pipefail
          mkdir -p "release/upload/${{ matrix.arch }}"

          for f in release/build/StratoSortCore-*-${{ matrix.arch }}.dmg release/build/StratoSortCore-*-${{ matrix.arch }}.zip; do
            if [ -f "$f" ]; then
              cp "$f" "release/upload/${{ matrix.arch }}/"
            fi
          done

          for f in release/build/latest*.yml; do
            if [ -f "$f" ]; then
              base="$(basename "$f")"
              cp "$f" "release/upload/${{ matrix.arch }}/${{ matrix.arch }}-$base"
            fi
          done

      - name: Upload macOS artifacts (${{ matrix.arch }})
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-artifacts
          path: release/upload/${{ matrix.arch }}
          if-no-files-found: error

  publish-release:
    needs: build-macos
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: macos-*-artifacts
          merge-multiple: true
          path: release/build

      - name: Generate SHA256 checksums
        run: |
          cd release/build
          rm -f checksums-macos.sha256

          for f in StratoSortCore-*.dmg StratoSortCore-*.zip; do
            [ -f "$f" ] && shasum -a 256 "$f" >> checksums-macos.sha256 || true
          done

          if [ ! -s checksums-macos.sha256 ]; then
            echo "No macOS build artifacts found to checksum."
            exit 1
          fi

      - name: Publish release artifacts
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: false
          fail_on_unmatched_files: false
          files: |
            release/build/StratoSortCore-*.dmg
            release/build/StratoSortCore-*.zip
            release/build/*latest*.yml
            release/build/checksums-macos.sha256
