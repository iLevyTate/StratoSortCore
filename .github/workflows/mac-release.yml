# Mac release workflow â€” run on tag push.
# electron-builder is configured to emit both arm64 and x64 mac artifacts.
name: Release (macOS)

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20.x
        uses: actions/setup-node@v6
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Mac app and DMG
        run: npm run dist:mac

      # Notarization requires Apple Developer ID. Uncomment when ready:
      # - name: Notarize app
      #   env:
      #     APPLE_ID: ${{ secrets.APPLE_ID }}
      #     APPLE_ID_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      #   run: |
      #     xcrun notarytool submit release/build/*.dmg --wait
      #     xcrun stapler staple release/build/*.dmg

      - name: Generate SHA256 checksums
        run: |
          cd release/build
          rm -f checksums-macos.sha256

          if [ -f latest.yml ]; then
            mv latest.yml latest-macos.yml
          fi

          for f in StratoSortCore-*.dmg StratoSortCore-*.zip; do
            [ -f "$f" ] && shasum -a 256 "$f" >> checksums-macos.sha256 || true
          done

          if [ ! -s checksums-macos.sha256 ]; then
            echo "No macOS build artifacts found to checksum."
            exit 1
          fi

      - name: Publish release artifacts
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: false
          fail_on_unmatched_files: false
          files: |
            release/build/StratoSortCore-*.dmg
            release/build/StratoSortCore-*.zip
            release/build/latest*.yml
            release/build/checksums-macos.sha256
